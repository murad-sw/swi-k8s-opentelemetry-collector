# Docker Image Update Workflow

## Overview

This workflow automatically updates Docker images in the Helm chart to their latest versions. It runs every Monday at 9:00 AM UTC and can also be triggered manually.

## Workflow Logic

The GitHub action follows this logic:

1. **Check for Updates**: Scans all Docker images in `deploy/helm/values.yaml` for available updates
2. **Branch Management**: 
   - If an `update-images` branch exists, switch to it and pull latest changes
   - If no branch exists, create a new one
3. **Apply Changes**: Update the YAML files with new image versions
4. **PR Management**:
   - If a PR already exists for the `update-images` branch, update it with new changes
   - If no PR exists, create a new one
   - If no updates are found, no PR is created or updated
5. **PR Description**: 
   - New PRs get a fresh description with all updated images
   - Existing PRs get their description updated to include new changes while preserving previous ones

## Files

- `.github/workflows/update-images.yml`: GitHub Actions workflow definition
- `utils/update_images.py`: Python script that handles the actual update logic

## Script Usage

### GitHub Actions Mode (Recommended)
```bash
python utils/update_images.py --pr-mode --github-token $GITHUB_TOKEN --repository $REPOSITORY --update-chart
```

### Local Development Mode
```bash
# Dry run to see what would be updated
python utils/update_images.py --dry-run

# Apply updates locally
python utils/update_images.py --update-chart

# Filter specific images
python utils/update_images.py --filter "solarwinds" --dry-run
```

## Arguments

- `--dry-run`: Only show what would be updated without making changes
- `--github-token`: GitHub token for API access (automatically set in Actions)
- `--repository`: GitHub repository in format `owner/repo` (automatically set in Actions)
- `--update-chart`: Also update the Chart.yaml version
- `--values-file`: Path to values.yaml file (default: `deploy/helm/values.yaml`)
- `--chart-file`: Path to Chart.yaml file (default: `deploy/helm/Chart.yaml`)
- `--filter`: Only update images containing this string in repository name
- `--pr-mode`: Enable PR mode for GitHub Actions

## PR Description Format

The PR description includes:
- List of all updated images with old and new versions
- Automatic footer indicating it was generated by the workflow
- Preserves and updates existing entries when PR already exists

## Security

- Uses `secrets.GITHUB_TOKEN` for GitHub API access
- No sensitive information is logged or exposed
- All operations are performed within the repository context

## Schedule

- **Automatic**: Every Monday at 9:00 AM UTC
- **Manual**: Can be triggered via GitHub Actions UI
