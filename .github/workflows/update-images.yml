name: Update Container Images

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (only show changes)'
        required: false
        default: false
        type: boolean
      filter:
        description: 'Filter images by repository name'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Import GPG key
      id: import_gpg
      uses: crazy-max/ghaction-import-gpg@v6
      continue-on-error: true
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY || '' }}
        passphrase: ${{ secrets.GPG_PASSPHRASE || '' }}
        git_user_signingkey: true
        git_commit_gpgsign: true
        git_tag_gpgsign: true
        git_push_gpgsign: false
        git_committer_name: github-actions[bot]
        git_committer_email: github-actions[bot]@users.noreply.github.com
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Configure Git (fallback for non-GPG)
      if: steps.import_gpg.outcome == 'failure' || steps.import_gpg.outcome == 'skipped'
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.signingkey ""
        git config --global commit.gpgsign false
    
    - name: Update container images
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python utils/update_images.py \
          --github-token "$GITHUB_TOKEN" \
          --repository "${{ github.repository }}" \
          --update-chart \
          --values-file "deploy/helm/values.yaml" \
          --chart-file "deploy/helm/Chart.yaml" \
          ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }} \
          ${{ github.event.inputs.filter && format('--filter "{0}"', github.event.inputs.filter) || '' }}
    
    - name: Show changes summary
      if: always()
      run: |
        if [ -f "changes.log" ]; then
          echo "## Image Updates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following images were updated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat changes.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "## No Image Updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No container images required updates." >> $GITHUB_STEP_SUMMARY
        fi
